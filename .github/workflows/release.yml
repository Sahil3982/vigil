- name: Build & Package Binaries
  run: |
    mkdir -p dist
    for os in linux darwin windows; do
      for arch in amd64 arm64; do
        echo "Building $os/$arch..."
        bin="vigil"
        if [ "$os" = "windows" ]; then bin="vigil.exe"; fi
        
        # Create a clean folder for this build
        stage="$(mktemp -d)"
        GOOS=$os GOARCH=$arch CGO_ENABLED=0 \
          go build -ldflags="-s -w" -o "$stage/$bin" .
        
        # Package the binary (named 'vigil' or 'vigil.exe') into .tar.gz
        tar -czf "dist/vigil_${{ github.ref_name }}_${os}_${arch}.tar.gz" -C "$stage" "$bin"
        
        # Cleanup
        rm -rf "$stage"
      done
    done